{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Create Account</h3>
                </div>
                <div class="card-body">
                    <!-- Display Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" class="needs-validation" novalidate autocomplete="off">
                        {{ form.csrf_token }}

                        <!-- Progress Indicator -->
                        <div class="progress mb-4" style="height: 3px;">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" id="formProgress"></div>
                        </div>

                        <!-- Basic Information Section -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    {{ form.first_name(class="form-control", id="first_name", placeholder="First Name", required=true, autocomplete="off") }}
                                    <label for="first_name">{{ form.first_name.label.text }}</label>
                                    <div class="invalid-feedback">
                                        Please enter your first name.
                                    </div>
                                    {% for error in form.first_name.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    {{ form.last_name(class="form-control", id="last_name", placeholder="Last Name", required=true, autocomplete="off") }}
                                    <label for="last_name">{{ form.last_name.label.text }}</label>
                                    <div class="invalid-feedback">
                                        Please enter your last name.
                                    </div>
                                    {% for error in form.last_name.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            {{ form.email(class="form-control", id="email", placeholder="Email", required=true, autocomplete="off") }}
                            <label for="email">{{ form.email.label.text }}</label>
                            <div class="invalid-feedback">
                                Please enter a valid email address.
                            </div>
                            {% for error in form.email.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="form-floating mb-3">
                            {{ form.password(class="form-control", id="password", placeholder="Password", required=true, autocomplete="off") }}
                            <label for="password">{{ form.password.label.text }}</label>
                            <div class="invalid-feedback">
                                Password must be at least 6 characters long.
                            </div>
                            {% for error in form.password.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="mb-3">
                            <div class="password-strength" id="passwordStrength">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted">Password strength: <span id="strengthText">None</span></small>
                            </div>
                        </div>

                        <div class="form-floating mb-4">
                            {{ form.user_type(class="form-control", id="user_type", required=true) }}
                            <label for="user_type">{{ form.user_type.label.text }}</label>
                            {% for error in form.user_type.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <!-- Student Fields -->
                        <div id="student-fields" class="role-fields" style="display: none;">
                            <h4 class="mb-3">Student Information</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.university(class="form-control", id="university", placeholder="University", autocomplete="off") }}
                                        <label for="university">{{ form.university.label.text }}</label>
                                        {% for error in form.university.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.major(class="form-control", id="major", placeholder="Major", autocomplete="off") }}
                                        <label for="major">{{ form.major.label.text }}</label>
                                        {% for error in form.major.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.gpa(class="form-control", id="gpa", placeholder="GPA", type="number", step="0.01", min="0", max="4", autocomplete="off") }}
                                        <label for="gpa">{{ form.gpa.label.text }}</label>
                                        {% for error in form.gpa.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.expected_graduation_date(class="form-control", id="expected_graduation_date", type="date", autocomplete="off") }}
                                        <label for="expected_graduation_date">{{ form.expected_graduation_date.label.text }}</label>
                                        {% for error in form.expected_graduation_date.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instructor Fields -->
                        <div id="instructor-fields" class="role-fields" style="display: none;">
                            <h4 class="mb-3">Instructor Information</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.department(class="form-control", id="department", placeholder="Department", autocomplete="off") }}
                                        <label for="department">{{ form.department.label.text }}</label>
                                        {% for error in form.department.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.specialization(class="form-control", id="specialization", placeholder="Specialization", autocomplete="off") }}
                                        <label for="specialization">{{ form.specialization.label.text }}</label>
                                        {% for error in form.specialization.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="form-floating mb-3">
                                {{ form.experience(class="form-control", id="experience", type="number", min="0", placeholder="Years of Experience", autocomplete="off") }}
                                <label for="experience">{{ form.experience.label.text }}</label>
                                {% for error in form.experience.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Company Fields -->
                        <div id="company-fields" class="role-fields" style="display: none;">
                            <h4 class="mb-3">Company Information</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.company_name(class="form-control", id="company_name", placeholder="Company Name", autocomplete="off") }}
                                        <label for="company_name">{{ form.company_name.label.text }}</label>
                                        {% for error in form.company_name.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.industry(class="form-control", id="industry", placeholder="Industry", autocomplete="off") }}
                                        <label for="industry">{{ form.industry.label.text }}</label>
                                        {% for error in form.industry.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.location(class="form-control", id="location", placeholder="Location", autocomplete="off") }}
                                        <label for="location">{{ form.location.label.text }}</label>
                                        {% for error in form.location.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        {{ form.company_size(class="form-control", id="company_size", type="number", min="1", placeholder="Company Size", autocomplete="off") }}
                                        <label for="company_size">{{ form.company_size.label.text }}</label>
                                        {% for error in form.company_size.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="form-floating mb-3">
                                {{ form.founded_date(class="form-control", id="founded_date", type="date", autocomplete="off") }}
                                <label for="founded_date">{{ form.founded_date.label.text }}</label>
                                {% for error in form.founded_date.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">Create Account</button>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <p>Already have an account? <a href="{{ url_for('auth.login') }}" class="text-primary">Login here</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-floating > label {
    padding: 1rem 0.75rem;
}
.progress-bar {
    transition: width 0.3s ease-in-out;
}
.card {
    border: none;
    border-radius: 15px;
}
.card-header {
    border-radius: 15px 15px 0 0 !important;
}
.btn-primary {
    padding: 0.8rem;
    font-weight: 500;
}
.role-fields {
    animation: fadeIn 0.3s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const userTypeSelect = document.getElementById('user_type');
    const studentFields = document.getElementById('student-fields');
    const instructorFields = document.getElementById('instructor-fields');
    const companyFields = document.getElementById('company-fields');
    const progressBar = document.getElementById('formProgress');
    const form = document.querySelector('form');
    const passwordInput = document.getElementById('password');
    const strengthBar = document.querySelector('#passwordStrength .progress-bar');
    const strengthText = document.getElementById('strengthText');

    // Defensive checks for debugging
    if (!userTypeSelect) { alert("User type select not found!"); }
    if (!studentFields) { alert("Student fields not found!"); }
    if (!instructorFields) { alert("Instructor fields not found!"); }
    if (!companyFields) { alert("Company fields not found!"); }

    // Toggle role-specific fields
    function toggleFields() {
        studentFields.style.display = 'none';
        instructorFields.style.display = 'none';
        companyFields.style.display = 'none';
        if (userTypeSelect.value === 'student') studentFields.style.display = 'block';
        if (userTypeSelect.value === 'instructor') instructorFields.style.display = 'block';
        if (userTypeSelect.value === 'company') companyFields.style.display = 'block';
        updateProgress();
    }

    // Update form progress
    function updateProgress() {
        const inputs = form.querySelectorAll('input:not([type="hidden"])');
        const filledInputs = Array.from(inputs).filter(input => input.value.trim() !== '');
        const progress = (filledInputs.length / inputs.length) * 100;
        progressBar.style.width = `${progress}%`;
    }

    // Check password strength
    function checkPasswordStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength += 25;
        if (password.match(/[a-z]+/)) strength += 25;
        if (password.match(/[A-Z]+/)) strength += 25;
        if (password.match(/[0-9]+/)) strength += 25;

        strengthBar.style.width = `${strength}%`;
        if (strength < 25) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Weak';
        } else if (strength < 50) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Fair';
        } else if (strength < 75) {
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Good';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong';
        }
    }

    // Event listeners
    if (userTypeSelect) userTypeSelect.addEventListener('change', toggleFields);
    if (form) form.addEventListener('input', updateProgress);
    if (passwordInput) passwordInput.addEventListener('input', (e) => checkPasswordStrength(e.target.value));

    // Form validation
    if (form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    }

    // Initialize
    if (userTypeSelect) toggleFields();
    if (form) updateProgress();
});
</script>
{% endblock %}